---
title: "SDS 291 Final Project Report"
author: "Miya Dang, Mia Tran, Alua Birgebayeva"
date: "Monday, April 28, 2025"
format: 
  pdf:
    keep-tex: true
    include-in-header: 
       text: |
         \usepackage{fvextra}
         \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
         \DefineVerbatimEnvironment{OutputCode}{Verbatim}{breaklines,commandchars=\\\{\}}
    geometry: 
      - left=1in
      - right=1in
      - top=1in
      - bottom=1in
editor_options: 
  chunk_output_type: inline
---
# Abstract

# Introduction

# Methods

## Exploratory Data Analysis

```{r, echo = FALSE, warning = FALSE, message = FALSE}
# Loading necessary packages
library(gtsummary)
library(ggplot2)
library(tidyr)
library(pROC)
library(car)
library(dplyr)
library(broom)

# Reading csv
heart_data <- read.csv("heart_failure_clinical_records_dataset.csv")

# Factoring categorical variables
heart_data$anaemia <- factor(heart_data$anaemia)
heart_data$diabetes <- factor(heart_data$diabetes)
heart_data$high_blood_pressure <- factor(heart_data$high_blood_pressure)
heart_data$sex <- factor(heart_data$sex)
heart_data$smoking <- factor(heart_data$smoking)
heart_data$DEATH_EVENT <- factor(heart_data$DEATH_EVENT)

# EDA summary table
tbl_summary(heart_data)
```

Boxplots for Ejection Fraction and Serum Creatinine by Death Event
```{r, echo = FALSE, warning = FALSE, message = FALSE}

# Reshape data to long format
heart_data_long <- heart_data %>%
  pivot_longer(
    cols = c(ejection_fraction, serum_creatinine),
    names_to = "variable",
    values_to = "value"
  )

# Create labels for faceting
variable_labels <- c(
  "ejection_fraction" = "Ejection Fraction (%)",
  "serum_creatinine" = "Serum Creatinine (mg/dL)"
)

# Create combined plot
ggplot(heart_data_long, aes(x = factor(DEATH_EVENT), y = value)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free_y") +
  labs(x = "Death Event (0 = Alive, 1 = Dead)",
       title = "Ejection Fraction and Serum Creatinine by Death Event"
  )
```


## Select Variables

```{r, echo = FALSE, warning = FALSE, message = FALSE}
# Selecting models by doing backward elimination using nested F test (p-value = 0.1)

heart_full <- glm(DEATH_EVENT ~ age + anaemia + creatinine_phosphokinase + diabetes + ejection_fraction + high_blood_pressure + platelets + serum_creatinine + serum_sodium + sex + smoking + time, data = heart_data, family = "binomial")

# drop1(heart_full, test = "F")
drop1_heart <- update(heart_full, . ~ . - anaemia)
# drop1(drop1_heart, test = "F")
drop1_heart <- update(drop1_heart, . ~ . - smoking)
# drop1(drop1_heart, test = "F")
drop1_heart <- update(drop1_heart, . ~ . - high_blood_pressure)
# drop1(drop1_heart, test = "F")
drop1_heart <- update(drop1_heart, . ~ . - diabetes)
#  drop1(drop1_heart, test = "F")
drop1_heart <- update(drop1_heart, . ~ . - platelets)
#  drop1(drop1_heart, test = "F")
drop1_heart <- update(drop1_heart, . ~ . - creatinine_phosphokinase)
# drop1(drop1_heart, test = "F")
drop1_heart <- update(drop1_heart, . ~ . - sex)
# drop1(drop1_heart, test = "F")

# Final model after moving variables
final_model <- drop1_heart
summary(final_model)

# Model diagnostics
# Cooks Distance


# Influential points

# Leverage
case_influence <- final_model |> augment()
case_influence <- case_influence |> mutate(row_id = row_number())
case_influence |> select(.hat)
# Calculating the threshold for unusually high leverage
k_plus_one <- length(coef(final_model))
n <- nrow(heart_data)
# Filtering the data to determine which observations have unusually high leverage
leverage_index <- case_influence |> filter(.hat > 2 * k_plus_one/n) |> select(row_id) |> pull()
heart_data[leverage_index, ]

case_influence |> ggplot(aes(x = row_id, y = .hat)) + geom_point() + 
  geom_hline(yintercept = 2*k_plus_one/n, col = "red") +
  xlab("") + ylab("Leverage")

# Studentized residuals
rstudent(final_model)
case_influence <- case_influence |> mutate(.stu.resid = rstudent(final_model))
stu_resid_id <- case_influence |> filter(.stu.resid < -2 | .stu.resid > 2) |> select(row_id) |> pull()
heart_data[stu_resid_id, ]

# Cook's dxistance
case_influence |> select(.cooksd)
case_influence |> filter(.cooksd > 1)
cooksd_id <- case_influence |> filter(.cooksd > 1) |> select(row_id) |> pull()
heart_data[cooksd_id, ]


# Checking conditions using Deviance residual plot
plot(residuals(final_model, type = "deviance"), ylab = "Deviance Residuals")

# Multicollinearity
vif(final_model)

# Model performance
```


